#!/usr/bin/env python3
"""
Custom tool for searching public exploits related to CVEs.
This module follows the Strands SDK's module-based tool specification.
"""

import requests
import json
from typing import Dict, Any, List
from strands.types.tools import ToolResult, ToolUse

TOOL_SPEC = {
    "name": "search_for_exploits",
    "description": (
        "Searches GitHub for public Proof-of-Concept (PoC) exploits related to a specific CVE ID. "
        "This is a critical tool for assessing the real-world risk of a vulnerability."
    ),
    "inputSchema": {
        "json": {
            "type": "object",
            "properties": {
                "cve_id": {
                    "type": "string",
                    "description": "The CVE identifier to search for exploits (e.g., 'CVE-2024-3094').",
                }
            },
            "required": ["cve_id"],
        }
    },
}

def search_for_exploits(tool: ToolUse, **kwargs: Any) -> ToolResult:
    tool_use_id = tool["toolUseId"]
    tool_input = tool["input"]
    cve_id = tool_input.get("cve_id")

    if not isinstance(cve_id, str) or not cve_id.upper().startswith("CVE-"):
        return {
            "toolUseId": tool_use_use_id,
            "status": "error",
            "content": [{"text": "Invalid CVE ID format. Must be a string like 'CVE-YYYY-NNNN'."}],
        }

    # Use the GitHub API to search for repositories mentioning the CVE.
    # This is a more reliable method than simple web scraping.
    query = f'''"{cve_id}" in:readme,description,topics'''
    url = f"https://api.github.com/search/repositories?q={query}&sort=updated&order=desc"
    headers = {"Accept": "application/vnd.github.v3+json"}

    try:
        response = requests.get(url, headers=headers, timeout=15)
        response.raise_for_status()
        data = response.json()

        if data["total_count"] == 0:
            return {
                "toolUseId": tool_use_id,
                "status": "success",
                "content": [{"json": {"summary": f"No public exploits found on GitHub for {cve_id}.", "links": []}}]
            }

        # Extract relevant information for the top 5 results.
        top_results: List[Dict[str, Any]] = []
        for item in data["items"][:5]:
            top_results.append({
                "name": item["full_name"],
                "url": item["html_url"],
                "description": item["description"],
                "stars": item["stargazers_count"],
                "last_updated": item["updated_at"],
            })
        
        summary = f"Found {data['total_count']} potential exploits on GitHub for {cve_id}. Returning the top 5 most recently updated."
        return {
            "toolUseId": tool_use_id,
            "status": "success",
            "content": [{"json": {"summary": summary, "links": top_results}}]
        }

    except requests.exceptions.RequestException as e:
        return {"toolUseId": tool_use_id, "status": "error", "content": [{"text": f"Request to GitHub API failed: {e}"}]}
    except json.JSONDecodeError:
        return {"toolUseId": tool_use_id, "status": "error", "content": [{"text": "Failed to parse JSON response from GitHub API."}]}
    except Exception as e:
        return {"toolUseId": tool_use_id, "status": "error", "content": [{"text": f"An unexpected error occurred: {e}"}]}