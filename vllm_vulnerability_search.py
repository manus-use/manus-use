import requests
import json
from datetime import datetime

def search_vllm_vulnerabilities():
    """Search for the 10 most recent vulnerabilities related to vLLM using GitHub API"""
    
    # GitHub API endpoint for searching issues
    api_url = "https://api.github.com/search/issues"
    
    # Search query parameters
    # Looking for issues/PRs that mention vulnerabilities and vLLM
    query = "vLLM vulnerability OR security OR CVE OR exploit OR weakness OR risk OR threat"
    sort = "updated"  # Sort by most recently updated
    order = "desc"    # Descending order (newest first)
    
    # Set up the request parameters
    params = {
        "q": query,
        "sort": sort,
        "order": order,
        "per_page": 10  # Limit to 10 results
    }
    
    # Make the request to GitHub API
    # Note: For unauthenticated requests, GitHub limits to 10 requests per minute
    headers = {
        "Accept": "application/vnd.github.v3+json"
    }
    
    try:
        response = requests.get(api_url, params=params, headers=headers)
        response.raise_for_status()  # Raise an exception for HTTP errors
        
        # Parse the JSON response
        data = response.json()
        
        print(f"Found {data['total_count']} potential vulnerability-related issues/PRs for vLLM")
        print("Top 10 most recent results:\n")
        
        # Display the results
        for i, item in enumerate(data['items'], 1):
            print(f"#{i}: {item['title']}")
            print(f"URL: {item['html_url']}")
            print(f"Created: {item['created_at']}")
            print(f"Updated: {item['updated_at']}")
            print(f"State: {item['state']}")
            print(f"Repository: {item['repository_url'].split('/')[-2]}/{item['repository_url'].split('/')[-1]}")
            print(f"Labels: {', '.join([label['name'] for label in item['labels']])}" if item['labels'] else "Labels: None")
            print("-" * 80)
            print()
        
        return data['items']
    
    except requests.exceptions.RequestException as e:
        print(f"Error making request to GitHub API: {e}")
    except KeyError as e:
        print(f"Error parsing response: {e}")
        print(f"Response content: {response.text}")
    except Exception as e:
        print(f"Unexpected error: {e}")
        
    return []

if __name__ == "__main__":
    search_vllm_vulnerabilities()